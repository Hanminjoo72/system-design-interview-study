## 13장 - 검색어 자동완성 시스템

### 1단계 문제 이해 및 설계 범위 지정

1. 사용자가 입력하는 단어는 자동완성될 검색어의 첫 부분이어야 하는지 중간 부분이어도 상관없는지 물어보기

2. 몇 개의 자동완성 검색어가 표시되어야 하는지 물어보기

3. 자동완성 검색어 5개를 고르는 기준이 무엇인지 물어보기

4. 맞춤법 검사 기능도 제공해야 하는지 물어보기

5. 질의는 영어인지 물어보기

6. 대문자나 특수 문자 처리도 해야하는지 물어보기

7. 얼마나 많은 사용자를 지원해야 하는가?

##### 요구사항
빠른 응답 속도 : 사용자가 검색어를 입력함에 따라 자동완성 검색어도 충분히 빠르게 표시되어야 한다. 페이스북의 경우 응답속도를 100 밀리초 이내라고 규정한다. 그렇지 않으면 시스템 이용이 불편해진다.

연관성 : 검색어는 사용자가 입력한 단어와 연관성이 있어야 한다.

정렬 : 시스템의 계산 결과는 인기도 등의 순위 모델에 의해 정렬되어야 한다.

규모 확장성 : 시스템은 많은 트래픽을 감당할 수 있도록 확장 가능해야 한다.

고가용성 : 시스템의 일부에 장애가 발생하거나 느려지거나, 예상치 못한 네트워크 문제가 발생해도 시스템은 계속 사용 가능해야 한다.

##### 개략적 규모 추정

- DAU는 천만 명으로 가정
- 평균적으로 한 사용자는 매일 10건의 검색을 수행한다고 가정
- 질의 할 때 평균적으로 20바이트의 데이터를 입력한다고 가정
  - 문자 인코딩 방법은 ASCII를 사용한다고 가정하면 1문자 = 1바이트이다.
  - 질의문은 평균적으로 4개의 단어로 이뤄진다고 가정, 각 단어는 평균적으로 다섯 글자로 구성된다.
  - 따라서 질의당 평균 4 x 5 = 20 바이트이다.
- 검색창에 글자를 입력할 때마다 클라이언트는 백엔드 서버로 요청을 보낸다. 따라서 평균적으로 1회 검색당 20건의 요청이 백엔드로 전달된다.  예를 들어 검색창에 dinner라고 입력하면 아래 처럼 순차적으로 6개의 요청이 생긴다.
  - search?q=d 
  - search?q=di
  - search?q=din
  - 등등.. 
- 대략 초당 24,000건의 질의 발생 = (10,000,000 x 10 질의 / 일 x 20자 / 24시간 / 3600초)
- 질의 가운데 20% 정도는 신규 검색어라고 가정.

### 2단계 개략적 설계안 제시 및 동의 구하기
개략적으로 보면 시스템은 크게 데이터 수집 서비스와 질의 서비스로 나눌 수 있다.

- 데이터 수집 서비스란 사용자가 입력한 질의를 실시간으로 수집하는 시스템이다.  질의한 단어와 횟수를 빈도 테이블에 저장
- 질의 서비스 : 주어진 질의에 다섯 개의 인기 검색어를 정렬해 놓는 서비스

### 3단계 상세 설계

#### 트라이 자료구조

<img src="images/minjoo/trie.png">

트리형태의 자료구조로 문자열을 꺼내는 연산에 초점을 맞추어 설계된 자료구조

- 루트노드는 빈 문자열 나타냄
- 각 노드는 하나의 글자 저장, 최대 26개(알파벳)의 자식 노드를 가질 수 있음
- 리프노드로 가며 하나의 단어, 또는 접두어 문자열을 표현

트라이 자료구조에선 노드에 문자를 저장하지만, 질의 빈도 수도 필요하니 노드에 빈도 정보도 저장할 필요가 있음.


어떻게 가장 많이 질의된 단어를 찾아낼까?

- 질의로 들어온 단어 또는 접두어를 표현하는 노드를 찾는다
- 해당 노드부터 시작하는 하위 트리를 탐색한다.
- 유효한 검색 문자열을 갖는 노드(유효노드)를 찾는다.
- 유효노드를 정렬해 가장 인기 있는 검색어를 찾는다.

최악의 경우, k개 결과 얻으려고 트라이 다 검색해야 할 수도 있다.

성능을 올릴 수 없을까?

- 접두어의 최대 길이 제한
- 각 노드에 인기 검색어 캐시
  - 노드에 인기 검색어를 저장해야 하므로 공간이 더 필요하다는 단점
  - 빠른 응답속도 필요하면 사용
위 방법을 통해 시간복잡도를 O(1)로 수렴시킬 수 있다.

#### 데이터 수집 서비스

매일 수천만 건의 질의
- 그 때마다 트라이 갱신? 실시간적인 인기검색어 변화 적음. 실시간 갱신 필요성 적음.
트라이를 만드는데 사용하는 데이터는 보통 데이터 분석 서비스/로깅 서비스로 부터 온다.

데이터 수집 서비스의 설계안

<img src="images/minjoo/data.png">

- Analytics logs: 입력된 질의에 관한 원본 데이터
- Aggregators: Log 취합 및 전처리, DB 저장
- Workers: 비동기적으로 트라이 자료구조 생성 및 저장
- Trie cache: 데이터 메모리에 유지시켜 읽기 연산 성능 높임 → 주기적으로 DB 스냅샷
- Trie DB
  - Document store
  - Key-value store

#### 질의 서비스
질의 서비스의 최적화 방안

- AJAX 요청
- 브라우저 캐싱 (제안된 검색어 캐싱)
- 데이터 샘플링 (N개 중 1개만 로깅)

#### 트라이 연산
###### 트라이 생성
데이터 분석 서비스의 로그나 DB로부터 취합된 데이터를 이용한다.

###### 트라이 갱신
1. 매주 한 번 갱신
- 새로운 트라이를 만들고 대체
2. 각 노드를 개별적으로 갱신
- 트라이가 작을때 고려해볼만 하다.
###### 저장소 규모 확장
첫 글자 기준으로 샤딩이 가능하다.

→ 서버가 최대 26대로 제한된다. (영어 알파벳 개수 26자)

→ 균등하게 나누기가 불가능하다. (x로 시작하는 것보다 c로 시작하는게 월등히 많다.)

→ 검색어 대응 샤드 관리자를 두어 어떤 검색어가 어느 저장소 서버에 저장되는지 정보를 관리한다.


